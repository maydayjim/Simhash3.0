兄弟连区块链入门教程以太坊源码分析以太坊随机数生成方式二。激励RNG的周期非常短，例如一个小时20个生成周期，如果没有周期的利润是0.001%,一个月的盈利会达到0.00001*20*24*30=0.144。为了达到14.4%每个月的盈利，并且RNG平均有n个参与者，运行智能合约C的费用为n*3*500*gasPrice+Ccost.（CCost是合约内部的gas消费，包括计算和存储）假设每个随机值平均有r个请求，每个请求的费用是pETH,那么收入是r*p.所以每个参与者每一次参与会收到rp-1500n*gasPrice-Ccost)/n。当前的gasPrice是10szabo,合约的消费大概是1500ngas，所以大概的净收入是(rp/n-0.03）ETH.假设每个RNG有10个参与者，并且抵押是1000ETH，所以如果RNG如果只请求一次，那么一次的费用是0.4ETH,如果请求是10次，那么一次请求的价格会被降到0.04ETHTheRANDAOactsasaninfrastructureintheEthereumsystem.Itiscalledbyothercontracts.Contractsfordifferentpurposesrequiredifferentrandomnumbers:someneedhighsecurity,suchaslottery;someneedsteadyresponsesandtherequestshouldberespondedimmediately,thesecontractsarenormallylow-value;someneedacallback,theywanttoreceiveanotificationwithrandomnumberswhennumbersareready.Obviouslyit\'simpossibletomeetdifferentrequirementsinvariousscenarioswithonlyoneRNGcontract,soalotofcontractswillbecreatedwithdifferentinitialparameters,butthebasicrulesarethesame.RANDAO作为以太坊系统的基础设施。被其他的合约调用。不同的合约因为有不同的目的所以需要不同的随机值：有些需要高度加密的，比如说抽奖;有些需要稳定的回应，并且要求立即作出回应,这些合约本身的价值不高;有些需要回调函数，当随机值已经生成的时候需要接收到通知。很明显通过单一的RNG合约不可能满足所有的不同的请求，所以使用了不同的初始值创建了很多智能合约，不过他们基本的规则是相同的。Forexample,ifweneedhighsecurity,wecansubstantiallyincreasethepledgeofthefirstphase.Thus,thecostofleadingtofailureofRNGprocessbynotrevealingsisgreatlyincreased.Andforthecontractswithoutmuchinterestinvolved,theminimumnumberofparticipantsandthepledgecanbelower.Let\'slookatanexampleofadAppbettingonoddorevennumbers,we\'llshowhowtoadjustthecontract\'sparameterstomeetthedesiredsecuritylevel,bymakingthecostofcheatinghigherthanexpectedearnings.Assumingthebetis1000ETH,thebettingcontractcallsaRNGcontractC1,ifC1failedtogeneratearandomnumberatrequestedblockheight,thenbettingcontractwaitsforthenextrandomnumberofC1,untilthereisonegenerated.比如，如果你需要高度安全，我们可以大大的增加第一阶段的抵押。这样不提供s的导致失败的概率会大大降低。对于那么资金不是很充足的合约，那么参与者的最小个数和抵押都可以降低。让我们看一个dapp的例子，这个例子用来赌数的奇数和偶数，我们会显示如何调整合约的参数来匹配适合的安全程度，通过让造假的成本大大高于收益。假设打赌是1000ETH，这个打赌的合约调用了RNG的合约C1,如果C1在请求的区块高度生成随机数失败了，打赌的合约会等待C1的下一个随机数，直到有一个生成成功。Let\'sbuildtheRNGcontractC1,andsetthepledgedETHofC1to2000.ThegamblerGplaysthebettingdAppbutalsoparticipatesinthecontract.Whenhefindshimselfinadisadvantageouspositionbeforeherevealshissecretnumber,hecanchoosenottoreveals,sothattheRNGfailedandhegotanotherchance.Buthewilllosethe2000pledgedETH,soalthoughhecanget1000ETHexpectedreturn,itisstillabaddeal.However,GcanreducehislossesonC1bysomemeans,suchasparticipatinginC1usingtwoaccounts,sendingtwosha3(s).ifinadisadvantageousposition,Gwillkeeponlyoneaccount\'ssecret,andifonlyoneparticipantexpectGparticipatetoinC1,Gwillonlylose1000ETHinC1,butGwillget1000ETHasexpectedreturn,whichisaworthytry.让我们构建RNG智能合约C1,并且设置抵押的值是2000。赌徒G参与了dApp的赌注，同时参与了RNG的智能合约。在他提交s之前，发现自己处在不利的状态。他可以选择不提交自己的s，这样RNG会失败，他会得到下一个机会。但是他会损失2000ETH的抵押，尽管他可以得到1000ETH的赌注，所以这样并不是一个好的交易。然而赌徒G可以使用其他的方式来减少损失，比如G可以使用两个账号参与RNG，发送两个sha3(s).如果在不利的状态，G会让一个账号不提交s，这样如果除了G之外只有另外一个其他的账号，G只会在G1上面损失1000ETH，但是G如果赌赢了可以得到1000ETH，所以也值得一试。ThisissuecanbefixedbyconfiscatingthepledgedETH,andnotreturnthemtoparticipantsasbonus.soacontractwith1000pledgedETHwillmeettherequirementofthebettingdApp.这种情况可以通过没收所有抵押来修复，不会把他们作为奖励返回。所以一个1000抵押的合约会符合赌博的要求。Besidesconfiscation,anotherschemecanpreventsuchattacksbyintroducinganadditionalsystem:RANDAOmembership.Tobecomeamemberyoumustpaydues,anyonepaidtheirduesisamember.Membershavedifferentlevelsaccordingtotheduestheypaid.Membershipdoesnotbelongtoacontract,butinsteadfunctionslikeapassporttoparticipateinsomeRANDAOcontracts.Ifabreachofanycontracthappens,thatperson\'smembershipwillbeendedandthedueswillbeconfiscated.NowwecanaddanadditionalagreementtoC1,C1willonlyacceptnumberscommittedbymemberswhoselevelofinvestmentishighenough(membershipduesover1000ETH).Thiswillensurethatnobodyhasafinancialmotivetotryanattack.除了没收，还有一个方案可以阻止这种攻击，那就是RANDAOmembership。为了成为成员，你必须缴纳成员费用。根据成员缴纳的费用的多少把成员分成不同的等级，成员系统不属于智能合约，而是作为一种类似护照的形式来参与一些RANDAO合约。如果发生违约情况，这个成员的会员资格会被终止，成员会用会被没收。现在我们可以给智能合约C1增加一个额外的协议，C1只接受会员会用大于一定值的成员来参与。这样来保证没有任何人会有财务动机来发动攻击。##QA:QuestandAnswerQ:WhynotlettheminersparticipateinRNG?Whynotusetxhash,nonceandotherblockchaindata?A:Minershavetheabilitytomanipulatetheseblockchaindata,andthuscanindirectlyaffectRNG.IfRNGcontainsblockchaindata,itwillgivetheminerscapacitytoconstructrandomnumbersintheirfavor.Q:为什么不让矿工来参与到RNG中？为什么不使用txhash,nonce或者其他区块链数据?A:矿工有能力才操纵这些区块链数据，而这些会对RNG产生影响。如果RNG包含了区块链数据，会给予矿工按照自己的行为构造随机数的能力。Q:theminerscanignorecertaintransactionsthatcontainrandomnumbertheydislike,howtodealwiththat?A:That\'swhyweneedatimewindowperiod.Areasonableperiodshouldbegreaterthan6blocks,webelievethatnobodycanproduce6blocksinsuccession.Soiftheparticipantishonest,andhesendnumbersimmediatelyaslongaseachtimewindowopen,hedoesn\'tneedtoworryaboutbeingexcluded.Q:矿工有能力忽略特定的包含了随机数的交易，如何处理这种情况？A:这就是为什么我们需要时间间隔。一个合理的时间间隔会大于6个区块，我们任务没有人能连续生成6个区块。所以如果参与者是忠诚的，而且在时间窗口内发送了那个数字，那么他不同担心会被矿工排除在外。Q:Whyuseallnumbersofallparticipants,ratherthanasubset?A:Theruletopickasubsetisdeterministic,soparticipantswilltrytotakespecifiedpositionofthecollectionbyvariousmeans,iftheysucceed,theywillknowinadvancewhattherandomnumberisgeneratingfromsubsets.Iftheruletopickasubsetisrandomised,thenwestillhavetheproblemoftruerandomisation.Q:为什么使用所有的参与者的所有的值，而不是其子集？A:选择一个子集的规则是确定性的，所以参与者将尝试通过各种方式来采集指定的集合位置，如果它们成功，他们将事先知道从子集中产生的随机数。如果选择一个子集的规则是随机的，那么我们仍然存在真正的随机化问题。Q:Wheredoespledgedduesgo?A:Itwillbedonatedtoacharity,orRANDAOtomaintainfunding.Q:没收的费用去哪了。会捐献给慈善机构，或者是RANDAO会维护一个基金。Note:f(s1,s2,...,sn)isafunctionwithmultipleinputs,forexampler=s1xors2xors3...xorsn,orr=sha3(sn+sha3(sn-1+...(sha3(s2+s1))))